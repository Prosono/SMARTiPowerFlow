views:
  - title: SMARTi PowerFlow™
    cards:
      - type: custom:gap-card
        visibility:
          - condition: screen
            media_query: '(min-width: 768px)'
      - type: horizontal-stack
        cards:
          - type: custom:mushroom-title-card
            title: SMARTi PowerFlow™
            subtitle: 'Velg aktive PowerFlow moduser:'
          - type: custom:gap-card
          - type: custom:button-card
            name: null
            tap_action:
              action: none
            styles:
              card:
                - background-color: transparent
                - background-image: >-
                    url('https://i.postimg.cc/3JQD604C/Powwe-Flo-Logo-drawio.png')
                - background-size: cover
                - background-position: center
                - border-radius: 8px
                - border: 0px solid rgba(0, 0, 0, 0.1)
                - padding: 8px 12px
                - margin: 4px
                - height: 100px
                - width: 100px
                - display: flex
                - align-items: center
                - justify-content: center
                - text-align: center
              name:
                - color: white
                - font-size: 16px
                - font-weight: bold
                - text-shadow: 0px 1px 2px rgba(0, 0, 0, 0.5)
        visibility:
          - condition: screen
            media_query: '(min-width: 768px)'
      - type: horizontal-stack
        cards:
          - type: custom:mushroom-title-card
            title: SMARTi PowerFlow™
            subtitle: 'Velg aktive PowerFlow moduser:'
          - type: custom:button-card
            name: null
            tap_action:
              action: none
            styles:
              card:
                - background-color: transparent
                - background-image: >-
                    url('https://i.postimg.cc/3JQD604C/Powwe-Flo-Logo-drawio.png')
                - background-size: cover
                - background-position: center
                - border-radius: 8px
                - border: 0px solid rgba(0, 0, 0, 0.1)
                - padding: 8px 12px
                - margin: 4px
                - margin-top: 40px
                - height: 50px
                - width: 50px
                - display: flex
                - align-items: center
                - justify-content: center
                - text-align: center
              name:
                - color: white
                - font-size: 16px
                - font-weight: bold
                - text-shadow: 0px 1px 2px rgba(0, 0, 0, 0.5)
        visibility:
          - condition: screen
            media_query: '(min-width: 0px) and (max-width: 767px)'
      - type: custom:gap-card
        visibility:
          - condition: screen
            media_query: '(min-width: 768px)'
      - type: horizontal-stack
        cards:
          - type: custom:gap-card
          - type: custom:button-card
            name: Nettleie
            entity: input_boolean.mode_nettleie
            tap_action:
              action: toggle
            icon: >
              [[[ return states['input_boolean.mode_nettleie'].state == 'on' ?
              'mdi:checkbox-marked-circle' :
              'mdi:checkbox-blank-circle-outline'; ]]]
            styles:
              card:
                - background-color: >
                    [[[ return states['input_boolean.mode_nettleie'].state ==
                    'on' ? 'var(--primary-color)' : 'var(--disabled-color)'; ]]]
                - color: >
                    [[[ return states['input_boolean.mode_nettleie'].state ==
                    'on' ? 'white' : '#424242'; ]]]
                - border-radius: 8px
                - box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2)
                - border: 1px solid rgba(0, 0, 0, 0.1)
                - padding: 8px 12px
                - margin: 4px
                - transition: background-color 0.3s ease
                - '&:hover':
                    - background-color: >
                        [[[ return states['input_boolean.mode_nettleie'].state
                        == 'on' ? '#39c015' : '#EEEEEE'; ]]]
              name:
                - font-weight: bold
                - font-size: 16px
                - text-transform: uppercase
              icon:
                - color: >
                    [[[ return states['input_boolean.mode_nettleie'].state ==
                    'on' ? 'white' : '#757575'; ]]]
          - type: custom:button-card
            name: Pris
            entity: input_boolean.mode_pris
            tap_action:
              action: toggle
            icon: >
              [[[ return states['input_boolean.mode_pris'].state == 'on' ?
              'mdi:checkbox-marked-circle' :
              'mdi:checkbox-blank-circle-outline'; ]]]
            styles:
              card:
                - background-color: >
                    [[[ return states['input_boolean.mode_pris'].state == 'on' ?
                    'var(--primary-color)' : 'var(--disabled-color)'; ]]]
                - color: >
                    [[[ return states['input_boolean.mode_pris'].state == 'on' ?
                    'white' : '#424242'; ]]]
                - border-radius: 8px
                - box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2)
                - border: 1px solid rgba(0, 0, 0, 0.1)
                - padding: 8px 12px
                - margin: 4px
                - transition: background-color 0.3s ease
                - '&:hover':
                    - background-color: >
                        [[[ return states['input_boolean.mode_pris'].state ==
                        'on' ? '#39c015' : '#EEEEEE'; ]]]
              name:
                - font-weight: bold
                - font-size: 16px
                - text-transform: uppercase
              icon:
                - color: >
                    [[[ return states['input_boolean.mode_pris'].state == 'on' ?
                    'white' : '#757575'; ]]]
          - type: custom:button-card
            name: Flex
            entity: input_boolean.mode_flex
            tap_action:
              action: >
                [[[ return states['input_boolean.mode_flex'].state == 'off' ?
                'none' : 'toggle'; ]]]
            icon: >
              [[[ return states['input_boolean.mode_flex'].state == 'on' ?
              'mdi:checkbox-marked-circle' :
              'mdi:checkbox-blank-circle-outline'; ]]]
            custom_fields:
              overlay: >
                [[[ return states['input_boolean.mode_flex'].state == 'off' ?
                'Kommer snart' : ''; ]]]
            styles:
              card:
                - background-color: >
                    [[[ return states['input_boolean.mode_flex'].state == 'on' ?
                    '#39c015' : ''; ]]]
                - color: >
                    [[[ return states['input_boolean.mode_flex'].state == 'on' ?
                    'white' : '#424242'; ]]]
                - border-radius: 8px
                - box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2)
                - border: 1px solid rgba(0, 0, 0, 0.1)
                - padding: 8px 12px
                - margin: 4px
                - transition: background-color 0.3s ease
                - position: relative
                - overflow: hidden
                - '&:hover':
                    - background-color: >
                        [[[ return states['input_boolean.mode_flex'].state ==
                        'on' ? '#39c015' : '#EEEEEE'; ]]]
              name:
                - font-weight: bold
                - font-size: 16px
                - text-transform: uppercase
              icon:
                - color: >
                    [[[ return states['input_boolean.mode_flex'].state == 'on' ?
                    'white' : '#757575'; ]]]
              custom_fields:
                overlay:
                  - position: absolute
                  - top: 0
                  - left: 0
                  - width: 100%
                  - height: 100%
                  - display: flex
                  - align-items: center
                  - justify-content: center
                  - background-color: rgba(0, 0, 0, 1)
                  - color: white
                  - font-size: 16px
                  - font-weight: bold
                  - text-align: center
                  - padding: 0 10px
                  - box-sizing: border-box
          - type: custom:gap-card
        visibility:
          - condition: screen
            media_query: '(min-width: 768px)'
      - type: custom:gap-card
        visibility:
          - condition: screen
            media_query: '(min-width: 768px)'
      - type: horizontal-stack
        cards:
          - type: custom:button-card
            name: Nettleie
            entity: input_boolean.mode_nettleie
            tap_action:
              action: toggle
            icon: >
              [[[ return states['input_boolean.mode_nettleie'].state == 'on' ?
              'mdi:checkbox-marked-circle' :
              'mdi:checkbox-blank-circle-outline'; ]]]
            styles:
              card:
                - background-color: >
                    [[[ return states['input_boolean.mode_nettleie'].state ==
                    'on' ? 'var(--primary-color)' : 'var(--disabled-color)'; ]]]
                - color: >
                    [[[ return states['input_boolean.mode_nettleie'].state ==
                    'on' ? 'white' : '#424242'; ]]]
                - border-radius: 8px
                - box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2)
                - border: 1px solid rgba(0, 0, 0, 0.1)
                - padding: 8px 12px
                - margin: 4px
                - transition: background-color 0.3s ease
                - '&:hover':
                    - background-color: >
                        [[[ return states['input_boolean.mode_nettleie'].state
                        == 'on' ? '#39c015' : '#EEEEEE'; ]]]
              name:
                - font-weight: bold
                - font-size: 16px
                - text-transform: uppercase
              icon:
                - color: >
                    [[[ return states['input_boolean.mode_nettleie'].state ==
                    'on' ? 'white' : '#757575'; ]]]
          - type: custom:button-card
            name: Pris
            entity: input_boolean.mode_pris
            tap_action:
              action: toggle
            icon: >
              [[[ return states['input_boolean.mode_pris'].state == 'on' ?
              'mdi:checkbox-marked-circle' :
              'mdi:checkbox-blank-circle-outline'; ]]]
            styles:
              card:
                - background-color: >
                    [[[ return states['input_boolean.mode_pris'].state == 'on' ?
                    'var(--primary-color)' : 'var(--disabled-color)'; ]]]
                - color: >
                    [[[ return states['input_boolean.mode_pris'].state == 'on' ?
                    'white' : '#424242'; ]]]
                - border-radius: 8px
                - box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2)
                - border: 1px solid rgba(0, 0, 0, 0.1)
                - padding: 8px 12px
                - margin: 4px
                - transition: background-color 0.3s ease
                - '&:hover':
                    - background-color: >
                        [[[ return states['input_boolean.mode_pris'].state ==
                        'on' ? '#39c015' : '#EEEEEE'; ]]]
              name:
                - font-weight: bold
                - font-size: 16px
                - text-transform: uppercase
              icon:
                - color: >
                    [[[ return states['input_boolean.mode_pris'].state == 'on' ?
                    'white' : '#757575'; ]]]
          - type: custom:button-card
            name: Flex
            entity: input_boolean.mode_flex
            tap_action:
              action: >
                [[[ return states['input_boolean.mode_flex'].state == 'off' ?
                'none' : 'toggle'; ]]]
            icon: >
              [[[ return states['input_boolean.mode_flex'].state == 'on' ?
              'mdi:checkbox-marked-circle' :
              'mdi:checkbox-blank-circle-outline'; ]]]
            custom_fields:
              overlay: >
                [[[ return states['input_boolean.mode_flex'].state == 'off' ?
                'Kommer snart' : ''; ]]]
            styles:
              card:
                - background-color: >
                    [[[ return states['input_boolean.mode_flex'].state == 'on' ?
                    '#39c015' : ''; ]]]
                - color: >
                    [[[ return states['input_boolean.mode_flex'].state == 'on' ?
                    'white' : '#424242'; ]]]
                - border-radius: 8px
                - box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2)
                - border: 1px solid rgba(0, 0, 0, 0.1)
                - padding: 8px 12px
                - margin: 4px
                - transition: background-color 0.3s ease
                - position: relative
                - overflow: hidden
                - '&:hover':
                    - background-color: >
                        [[[ return states['input_boolean.mode_flex'].state ==
                        'on' ? '#39c015' : '#EEEEEE'; ]]]
              name:
                - font-weight: bold
                - font-size: 16px
                - text-transform: uppercase
              icon:
                - color: >
                    [[[ return states['input_boolean.mode_flex'].state == 'on' ?
                    'white' : '#757575'; ]]]
              custom_fields:
                overlay:
                  - position: absolute
                  - top: 0
                  - left: 0
                  - width: 100%
                  - height: 100%
                  - display: flex
                  - align-items: center
                  - justify-content: center
                  - background-color: rgba(0, 0, 0, 1)
                  - color: white
                  - font-size: 16px
                  - font-weight: bold
                  - text-align: center
                  - padding: 0 10px
                  - box-sizing: border-box
        visibility:
          - condition: screen
            media_query: '(min-width: 0px) and (max-width: 767px)'
      - type: custom:button-card
        styles:
          card:
            - height: 5px
            - max-height: 10px
            - padding: 0
            - margin: 0
            - background-color: var(--primary-color);
        card_mod:
          style: |
            ha-card {
              border-radius: 1px;
              height: 2px;
              max-height: 2px;
              padding: 0;
              margin: 0;
              background: var(--primary-color);
            }
      - type: horizontal-stack
        cards:
          - type: custom:mushroom-entity-card
            entity: sensor.power_saver_status
            name: Billigste time
            icon_color: primary
            layout: vertical
          - type: custom:mushroom-entity-card
            entity: sensor.effective_electricity_price
            icon: mdi:currency-usd
            icon_color: primary
            layout: vertical
            name: Effektiv Strømpris
          - type: custom:mushroom-entity-card
            entity: sensor.current_energy_level
            icon: mdi:currency-usd
            name: Nåværende Energinivå
            icon_color: primary
            layout: vertical
          - type: custom:mushroom-entity-card
            entity: input_number.energy_target
            icon: mdi:currency-usd
            name: Brukervalgt energinivå
            icon_color: primary
            layout: vertical
      - type: custom:gap-card
        visibility:
          - condition: screen
            media_query: '(min-width: 0px)'
      - type: custom:mod-card
        card_mod:
          style:
            .: |
              ha-card {
                --ha-card-border-width: 0.5px;
                --ha-card-border-radius: 20px;
              } 
            tabbed-card $:
              mwc-tab:
                $: |
                  .mdc-tab--active {
                    background: linear-gradient(to left, var(--accent-color), rgb(var(--rgb-primary-color-darker))) !important;
                    border-radius: 5px 5px 0px 0px;
                  }
                  mwc-tab:hover {
                    --mdc-theme-primary: red;
                    --mdc-tab-color-default: red;
                      }            
        card:
          type: custom:tabbed-card
          options:
            defaultTabIndex: null
          tabs:
            - attributes:
                label: Nettleie
                icon: mdi:finance
                isFadingIndicator: true
                isMinWidthIndicator: true
              card:
                type: vertical-stack
                cards:
                  - type: custom:mushroom-title-card
                    title: Nettleie
                    subtitle: Styrer enheter kun basert på satt effektledd
                  - type: custom:mushroom-title-card
                    title: null
                    subtitle: Smart Nettleiestyring
                  - type: custom:bar-card
                    title: Styrbar Effekt - Nettleie
                    entities:
                      - entity: sensor.controllable_power_percentage
                        name: Styrbar Effekt
                        color: rgba(76, 175, 80, 0.85)
                        icon: mdi:flash
                      - entity: sensor.non_controllable_power_percentage
                        name: Ikke-Styrbar Effekt
                        color: var(--primary-color)
                        icon: mdi:power-plug-off
                    max: 100
                    height: 40px
                    stack: vertical
                    positions:
                      icon: inside
                      indicator: inside
                      title: inside
                      name: inside
                      value: inside
                    style: |
                      bar-card-title {
                        font-size: 1.4em;
                        font-weight: bold;
                        color: var(--primary-color);
                        text-align: center;
                        margin-bottom: 12px;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                      }
                      bar-card-bar {
                        border-radius: 15px;
                        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
                        margin: 5px;
                      }
                      bar-card-value {
                        font-weight: bold;
                        font-size: 1.1em;
                      }
                      bar-card-name {
                        font-size: 1em;
                        color: var(--secondary-text-color);
                      }
                                       
                  - type: custom:mushroom-entity-card
                    entity: sensor.remaining_energy
                    icon: mdi:lightning-bolt-circle
                    icon_color: primary
                    layout: vertical
                    name: Gjenstående kW/h (for ikke å bryte effektledd)
                    fill_container: false
                  - type: conditional
                    conditions:
                      - entity: input_boolean.advanced_mode_view
                        state: 'on'
                    card:
                      type: custom:apexcharts-card
                      graph_span: 1h
                      update_interval: 1s
                      header:
                        show: true
                        title: Forbruk (Siste time)
                        show_states: true
                        colorize_states: true
                      series:
                        - entity: sensor.dynamic_power_kw
                          name: Nåværende Forbruk
                          type: line
                          color: green
                          stroke_width: 2
                        - entity: input_number.energy_target
                          name: Kapasitetsmål (kWh)
                          type: line
                          color: var(--primary-color)
                          stroke_width: 2
                        - entity: sensor.remaining_energy
                          name: Kapasitetsmål (kWh)
                          type: line
                          color: var(--accent-color)
                          stroke_width: 2
                        - entity: sensor.hourly_energy_usage_divided
                          name: Forbruk denne timen
                          type: line
                          color: var(--primary-color)
                          stroke_width: 2
                      yaxis:
                        - min: 0
                          decimals: 1
                      apex_config:
                        chart:
                          height: 300
                        plotOptions:
                          line:
                            curve: smooth
                        legend:
                          show: true
                  - type: custom:mushroom-title-card
                    title: Enheter
                    subtitle: Viser statusen til enheter som styres etter nettleie
                  - type: horizontal-stack
                    cards:
                      - type: vertical-stack
                        cards:
                          - type: custom:auto-entities
                            card:
                              title: Devices in Category 1
                              type: custom:layout-card
                              layout_type: grid
                              card_param: cards
                            filter:
                              template: >
                                {% set entities_str = [
                                  states('sensor.category_1_device_entities_part1'),
                                  states('sensor.category_1_device_entities_part2'),
                                  states('sensor.category_1_device_entities_part3'),
                                  states('sensor.category_1_device_entities_part4')
                                ] | join(',') %} {% set exclude_entities = ['No
                                devices added', 'unknown', '', None] %} {% set
                                entity_ids = entities_str.split(',') |
                                map('trim') | reject('in', exclude_entities) |
                                list %} {% set entities = expand(entity_ids)
                                  | rejectattr('state', 'equalto', 'unavailable')
                                  | sort(attribute='attributes.friendly_name')
                                  | map(attribute='entity_id')
                                  | list %}
                                {{ entities }}
                            card_options:
                              type: custom:mushroom-entity-card
                              layout: horizontal
                              fill_container: true
                              primary_info: name
                              secondary_info: state
                            debug: true
                      - type: vertical-stack
                        cards:
                          - type: custom:auto-entities
                            card:
                              title: Category 1 Device Power Consumption
                              type: custom:layout-card
                              layout_type: grid
                              card_param: cards
                            filter:
                              template: >
                                {% set entities_str = [
                                  states('sensor.category_1_device_power_entities_part1'),
                                  states('sensor.category_1_device_power_entities_part2'),
                                  states('sensor.category_1_device_power_entities_part3'),
                                  states('sensor.category_1_device_power_entities_part4')
                                ] | join(',') %} {% set exclude_entities = ['No
                                power sensors available', 'unknown', '', None]
                                %} {% set entity_list = entities_str.split(',')
                                | map('trim') | list %} {% set entity_ids =
                                entity_list | reject('in', exclude_entities) |
                                list %} {% set entities = expand(entity_ids)
                                  | rejectattr('state', 'equalto', 'unavailable')
                                  | sort(attribute='attributes.friendly_name')
                                  | map(attribute='entity_id')
                                  | list %}
                                {{ entities }}
                            card_options:
                              type: custom:mushroom-entity-card
                              layout: horizontal
                              fill_container: true
                              primary_info: name
                              secondary_info: state
                            debug: true
                  - type: custom:mushroom-title-card
                    title: Legg til / fjern enhet
                    subtitle: Enheter som styres etter nettleie
                  - type: horizontal-stack
                    cards:
                      - type: vertical-stack
                        cards:
                          - type: entities
                            entities:
                              - entity: input_select.new_category_1_device
                                name: Select Device to Add
                          - type: custom:button-card
                            name: Legg til enhet
                            icon: mdi:plus-circle
                            tap_action:
                              action: call-service
                              service: input_button.press
                              service_data:
                                entity_id: input_button.add_device_category_1_button
                            styles:
                              card:
                                - background-color: rgba(76, 175, 80, 0.85)
                                - color: white
                                - height: 50px
                                - display: flex
                                - align-items: center
                                - justify-content: center
                              name:
                                - font-size: 14px
                                - font-weight: bold
                      - type: vertical-stack
                        cards:
                          - type: entities
                            entities:
                              - entity: input_select.delete_category_1_device
                                name: Select Device to Delete
                          - type: custom:button-card
                            name: Slett Enhet
                            icon: mdi:delete
                            tap_action:
                              action: call-service
                              service: input_button.press
                              service_data:
                                entity_id: input_button.delete_category_1_device_button
                            styles:
                              card:
                                - background-color: red
                                - color: white
                                - height: 50px
                                - display: flex
                                - align-items: center
                                - justify-content: center
                              name:
                                - font-size: 14px
                                - font-weight: bold
                  - type: conditional
                    conditions:
                      - entity: input_boolean.advanced_mode_view
                        state: 'on'
                    card:
                      type: custom:mushroom-title-card
                      title: Forbruk
                      subtitle: Forbruk for enheter stryt av Nettleie
                  - type: conditional
                    conditions:
                      - entity: input_boolean.advanced_mode_view
                        state: 'on'
                    card:
                      type: custom:auto-entities
                      card:
                        title: Category 1 Device Power Consumption
                        type: history-graph
                        hours_to_show: 24
                        refresh_interval: 60
                      filter:
                        template: >
                          {% set entities_str = [
                            states('sensor.category_1_device_power_entities_part1'),
                            states('sensor.category_1_device_power_entities_part2'),
                            states('sensor.category_1_device_power_entities_part3'),
                            states('sensor.category_1_device_power_entities_part4')
                          ] | join(',') %} {% set exclude_entities = ['No power
                          sensors available', 'unknown', '', None] %} {% set
                          entity_list = entities_str.split(',') | map('trim') |
                          list %} {% set entity_ids = entity_list | reject('in',
                          exclude_entities) | list %} {% set entities =
                          expand(entity_ids)
                            | rejectattr('state', 'equalto', 'unavailable')
                            | sort(attribute='attributes.friendly_name' or 'entity_id')
                            | map(attribute='entity_id')
                            | list %}
                          {{ entities }}
                      debug: true
            - attributes:
                label: Pris
                icon: mdi:currency-usd
                isFadingIndicator: true
                isMinWidthIndicator: true
              card:
                type: vertical-stack
                cards:
                  - type: vertical-stack
                    cards:
                      - type: custom:mushroom-title-card
                        title: Pris
                        subtitle: Styr kun etter pris
                  - type: custom:apexcharts-card
                    graph_span: 48h
                    header:
                      title: Electricity Prices
                      show: true
                    span:
                      start: day
                    apex_config:
                      chart:
                        height: 390px
                    now:
                      show: true
                      label: Now
                    experimental:
                      color_threshold: true
                    yaxis:
                      - id: price
                        opposite: false
                        decimals: 2
                        min: 0
                        apex_config:
                          tickAmount: 5
                          labels:
                            show: true
                          legend:
                            show: false
                      - id: powersaver
                        opposite: true
                        decimals: 0
                        min: 0
                        max: 1
                        apex_config:
                          tickAmount: 7
                          labels:
                            show: true
                          legend:
                            show: true
                    series:
                      - entity: sensor.effective_electricity_price
                        name: Effective Electricity Price
                        opacity: 1
                        float_precision: 2
                        extend_to: now
                        yaxis_id: price
                        curve: smooth
                        color: red
                        stroke_width: 2
                        show:
                          legend_value: false
                          in_header: true
                          name_in_header: false
                          datalabels: false
                        data_generator: |
                          const data = entity.attributes.hours.map(hour => {
                            return [new Date(hour.start), hour.price];
                          });
                          return data;
                      - entity: sensor.nordpool_price
                        name: Nordpool Price
                        opacity: 1
                        float_precision: 2
                        extend_to: now
                        yaxis_id: price
                        curve: smooth
                        color: '#6B9EFF'
                        stroke_width: 2
                        show:
                          legend_value: false
                          in_header: true
                          name_in_header: false
                          datalabels: false
                        data_generator: |
                          const data = entity.attributes.hours.map(hour => {
                            return [new Date(hour.start), hour.price];
                          });
                          return data;
                      - entity: sensor.government_support
                        name: Government Support
                        opacity: 1
                        float_precision: 2
                        extend_to: now
                        yaxis_id: price
                        curve: stepline
                        color: green
                        stroke_width: 1
                        show:
                          legend_value: false
                          in_header: true
                          name_in_header: false
                          datalabels: false
                        data_generator: |
                          const data = entity.attributes.hours.map(hour => {
                            return [new Date(hour.start), hour.price];
                          });
                          return data;
                      - entity: sensor.effective_grid_tariff
                        name: Grid Tariff
                        opacity: 1
                        float_precision: 2
                        extend_to: now
                        yaxis_id: price
                        curve: stepline
                        color: '#FF8800'
                        stroke_width: 3
                        show:
                          legend_value: false
                          in_header: true
                          name_in_header: false
                          datalabels: false
                        data_generator: |
                          const data = entity.attributes.hours.map(hour => {
                            return [new Date(hour.start), hour.price];
                          });
                          return data;
                  - type: custom:apexcharts-card
                    header:
                      show: true
                      title: Pris i dag + Forbruk + Powersaver
                    now:
                      show: true
                      label: Nå
                    graph_span: 2d
                    span:
                      start: day
                    apex_config:
                      chart:
                        height: 400px
                      stroke:
                        width: 2
                      dataLabels:
                        enabled: true
                      fill:
                        type: solid
                      legend:
                        show: true
                      yaxis:
                        - id: price
                          show: true
                          tickAmount: 6
                          opposite: true
                          decimalsInFloat: 1
                          floating: false
                          forceNiceScale: true
                          extend_to: end
                        - id: usage
                          decimalsInFloat: 0
                          show: true
                          min: 0
                          forceNiceScale: true
                        - id: powersaver
                          show: false
                          decimalsInFloat: 0
                          floating: false
                          extend_to: now
                    series:
                      - entity: sensor.effective_electricity_price
                        yaxis_id: price
                        extend_to: now
                        name: Faktisk strømpris
                        type: line
                        curve: stepline
                        color: tomato
                        float_precision: 2
                        show:
                          legend_value: false
                        data_generator: |
                          return entity.attributes.hours.map((entry) => {
                            return [new Date(entry.start), entry.price];
                          });
                      - entity: sensor.hourly_energy_usage
                        yaxis_id: usage
                        type: column
                        color: var(--primary-color)
                        name: Forbruk
                        group_by:
                          duration: 1h
                          func: max
                        show:
                          legend_value: true
                      - entity: sensor.power_saver_payload
                        data_generator: |
                          return entity.attributes.hours.map((entry) => {
                            return [new Date(entry.start), entry.onOff];
                          });
                        yaxis_id: powersaver
                        name: Power Saver
                        type: area
                        color: rgb(0, 255, 0)
                        opacity: 0.7
                        stroke_width: 2
                        curve: stepline
                        group_by:
                          func: max
                        show:
                          legend_value: false
                          in_header: false
                          name_in_header: false
                          datalabels: false
            - attributes:
                label: Flex
                icon: mdi:chart-timeline-variant-shimmer
                isFadingIndicator: true
                isMinWidthIndicator: true
              card:
                type: vertical-stack
                cards:
                  - type: custom:mushroom-title-card
                    title: Ops...
                    subtitle: Flex er ikke tiljgengelig for øyeblikket.
            - attributes:
                label: PowerFlow™ innstillinger
                icon: mdi:cog
              card:
                type: vertical-stack
                cards:
                  - type: custom:mushroom-title-card
                    title: PowerFlow™ Settings
                    subtitle: Power specific settings
                  - type: entities
                    entities:
                      - entity: input_boolean.advanced_mode_view
                        name: Avansert visning
                  - type: horizontal-stack
                    cards:
                      - type: custom:mushroom-select-card
                        entity: input_select.home_power_measurement_device
                        icon_color: primary
                        primary_info: name
                        secondary_info: last-changed
                        name: Strømmålerliste
                      - type: custom:mushroom-template-card
                        primary: Klikk for å oppdatere strømmålerlisten
                        secondary: >
                          Sist Oppdatert: {% set last_triggered =
                          state_attr('automation.update_power_measurement_device_list',
                          'last_triggered') %} {% if last_triggered %}
                            {% set time_diff = (now() - last_triggered).total_seconds() %}
                            {% if time_diff < 60 %}
                              {{ time_diff | round }} seconds ago
                            {% elif time_diff < 3600 %}
                              {{ (time_diff / 60) | round }} minutes ago
                            {% elif time_diff < 86400 %}
                              {{ (time_diff / 3600) | round }} hours ago
                            {% else %}
                              {{ (time_diff / 86400) | round }} days ago
                            {% endif %}
                          {% else %}
                            Never triggered
                          {% endif %}
                        icon: mdi:lightning-bolt
                        badge_icon: mdi:update
                        badge_color: primary
                        tap_action:
                          action: call-service
                          service: automation.trigger
                          service_data:
                            entity_id: automation.update_power_measurement_device_list
                        fill_container: true
                        layout: vertical
                        card_mod:
                          style: |
                            ha-card {
                              --ha-card-background: var(--ha-card-background) !important;
                            }
                  - type: custom:mushroom-select-card
                    entity: input_select.frequency_hz
                    icon_color: primary
                    primary_info: name
                    secondary_info: last-changed
                    name: Frekvens (Hz)
                  - type: custom:mushroom-select-card
                    entity: input_select.phases_selection
                    icon_color: primary
                    primary_info: name
                    secondary_info: last-changed
                    name: Faser
                  - type: custom:mushroom-select-card
                    entity: input_select.main_fuse_size
                    icon_color: primary
                    primary_info: name
                    secondary_info: last-changed
                    name: Hovedsikring (A)
                  - type: custom:mushroom-select-card
                    entity: input_select.voltage_level
                    icon_color: primary
                    primary_info: name
                    secondary_info: last-changed
                    name: Spenningsnivå (V)
                  - type: custom:mushroom-select-card
                    entity: input_select.stromsoner
                    name: Strømsone
                    icon_color: primary
                    primary_info: name
                  - type: custom:mushroom-select-card
                    entity: input_select.nettselskap
                    icon_color: primary
                  - type: entities
                    entities:
                      - entity: input_boolean.advanced_mode_view
                        name: Avansert visning
                  - type: custom:mushroom-title-card
                    title: Inntillinger Nettleie
                    subtitle: Innstillinger for smart nettleietyring
                  - type: custom:numberbox-card
                    border: true
                    entity: input_number.energy_target
                    name: false
                    card_mod:
                      style: |
                        .cur-num{font-size:35px !important}
                        ha-card {
                          border-radius: 15px;
                          padding: 12px;
                          backdrop-filter: blur(6px);
                          color: var(--primary-text-color);
                          display: flex;
                          flex-direction: column;
                          align-items: center;
                        }
                        .body {
                          display: block !important;
                          font-size: 1em;
                          font-weight: bold;
                          color: var(--primary-color);
                          margin-top: 8px;
                        }
                        .body::after {
                          content: "Kilowattgrense per time";
                          font-size: 1em;
                          font-weight: 500;
                          color: var(--secondary-text-color);
                          margin-top: 6px;
                          display: block;
                          text-transform: uppercase;
                          letter-spacing: 0.05em;
                        }        
                  - type: custom:mushroom-title-card
                    title: Inntillinger Pris
                    subtitle: Innstillinger for smart prisstyring
                  - type: entities
                    entities:
                      - entity: input_number.cheapest_hours
                        name: Antall timer for billig strøm
                  - type: entities
                    title: Electricity Price Controls
                    entities:
                      - entity: input_select.price_zone
                        name: Price Zone
                      - entity: input_boolean.include_vat
                        name: Include VAT
      - type: entity
        entity: sensor.hourly_energy_usage
      - type: vertical-stack
        cards:
          - type: entities
            title: Grid Tariff Settings
            entities:
              - input_boolean.automatic_tariff
      - type: vertical-stack
        cards:
          - type: entities
            title: Grid Tariff Settings
            entities:
              - input_select.nettselskap
        visibility:
          - condition: state
            entity: input_boolean.automatic_tariff
            state: 'on'
      - type: vertical-stack
        cards:
          - type: entities
            title: Grid Tariff Settings
            entities:
              - entity: input_boolean.use_day_fee
              - entity: input_number.day_fee
              - entity: input_datetime.day_tariff_start
          - type: entities
            title: Grid Tariff Settings
            entities:
              - entity: input_boolean.use_night_fee
              - entity: input_number.night_fee
              - entity: input_datetime.night_tariff_start
          - type: entities
            title: Grid Tariff Settings
            entities:
              - entity: input_boolean.use_weekend_fee
              - entity: input_number.weekend_fee
          - type: sensor
            entity: sensor.effective_grid_tariff
            name: Effective Grid Tariff
        visibility:
          - condition: state
            entity: input_boolean.automatic_tariff
            state: 'off'
    badges:
      - type: custom:button-card
        name: Update Device Options
        icon: mdi:refresh
        color_type: icon
        show_name: true
        show_icon: true
        tap_action:
          action: call-service
          service: automation.trigger
          service_data:
            entity_id: automation.populate_category_device_options
        styles:
          card:
            - border-radius: 15px
            - box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.3)
          icon:
            - color: var(--primary-color)
          name:
            - font-weight: bold
            - font-size: 16px
            - color: var(--text-color)
    type: custom:horizontal-layout
    layout:
      max_width: 2000
      max_cols: 1
    background:
      image: /api/image/serve/48a41f07e2695235c3b28d4c8eddf539/original
